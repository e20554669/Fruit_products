FROM python:3.12-slim-bullseye

ENV TZ=Asia/Taipei
ENV POETRY_HOME="/opt/poetry"
ENV PATH="$POETRY_HOME/bin:$PATH"

# --- 1. å®‰è£èˆ‡é…ç½® (å–®ä¸€é«˜æ•ˆ RUN å±¤) ---
RUN apt-get update && \
    apt-get install -y --no-install-recommends git zsh vim curl procps gcc python3-dev && \
    \
    # æ™‚å€è¨­å®š
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone && \
    \
    # å®‰è£ Poetry
    pip install pipx && \
    pipx install poetry && \
    \
    # åŸ·è¡Œç‰©ç†ç¦ç”¨ pip çš„æ“ä½œ
    if [ -f /usr/local/bin/pip ]; then \
        mv /usr/local/bin/pip /usr/local/bin/pip_disabled_by_docker ; \
    fi && \
    if [ -f /usr/local/bin/pip3 ]; then \
        mv /usr/local/bin/pip3 /usr/local/bin/pip3_disabled_by_docker ; \
    fi && \
    echo '#!/bin/bash\necho "éŒ¯èª¤ï¼šè«‹ä½¿ç”¨ Poetry ç®¡ç†ä¾è³´ï¼Œè€Œä¸æ˜¯ pipï¼" > /usr/local/bin/pip && exit 1' > /usr/local/bin/pip && \
    chmod +x /usr/local/bin/pip && \
    \
    # å®‰è£ Oh My Zsh
    echo "Y" | sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" && \
    \
    # ğŸŒŸ é—œéµä¿®æ­£ï¼šå°‡ Poetry PATH å¯«å…¥ Zsh è¨­å®šæª” (.zshrc) ğŸŒŸ
    echo 'export POETRY_HOME="/opt/poetry"' >> /root/.zshrc && \
    echo 'export PATH="$POETRY_HOME/bin:$PATH"' >> /root/.zshrc && \
    \
    # æ¸…ç†ä»¥ç¸®å°æ˜ åƒæª”å¤§å°
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

# --- 2. è¤‡è£½ Poetry ä¾è³´æ–‡ä»¶ï¼ˆä¸éœ€å®‰è£ï¼Œç•™çµ¦ postCreateCommand.shï¼‰---
COPY pyproject.toml poetry.lock ./

# --- 3. è¤‡è£½å°ˆæ¡ˆç¨‹å¼ç¢¼ ---
COPY . .